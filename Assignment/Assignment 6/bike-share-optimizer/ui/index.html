<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike-Share Pass Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .input-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 12px;
            background: #e9ecef;
            border: 2px dashed #adb5bd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #dee2e6;
            border-color: #4facfe;
        }

        .run-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .run-button:hover {
            transform: translateY(-2px);
        }

        .run-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .timeline-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .timeline-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-item.thought {
            border-left-color: #28a745;
        }

        .timeline-item.action {
            border-left-color: #ffc107;
        }

        .timeline-item.observation {
            border-left-color: #17a2b8;
        }

        .timeline-item.final-answer {
            border-left-color: #dc3545;
        }

        .timeline-item.error {
            border-left-color: #6c757d;
        }

        .timeline-type {
            font-weight: 600;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            min-width: 80px;
            text-align: center;
        }

        .timeline-type.thought {
            background: #28a745;
        }

        .timeline-type.action {
            background: #ffc107;
            color: #212529;
        }

        .timeline-type.observation {
            background: #17a2b8;
        }

        .timeline-type.final-answer {
            background: #dc3545;
        }

        .timeline-type.error {
            background: #6c757d;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-timestamp {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .results-section {
            grid-column: 1 / -1;
            margin-top: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
        }

        .results-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .decision-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .decision-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .recommendation {
            font-size: 1.5rem;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 10px;
        }

        .cost-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .cost-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cost-card h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .cost-amount {
            font-size: 2rem;
            font-weight: 600;
            color: #dc3545;
        }

        .cost-amount.savings {
            color: #28a745;
        }

        .metrics-strip {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .citations {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .citations h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .citation-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .cost-comparison {
                grid-template-columns: 1fr;
            }
            
            .metrics-strip {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bike-Share Pass Optimizer</h1>
            <p>AI-powered analysis to help you choose between pay-per-ride and monthly membership</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>Upload Your Data</h2>
                <form id="analysisForm">
                    <div class="form-group">
                        <label for="csvFile">Trip Data (CSV File)</label>
                        <div class="file-upload">
                            <input type="file" id="csvFile" accept=".csv" required>
                            <label for="csvFile" class="file-upload-label">
                                <span id="fileLabel">Choose CSV file or drag and drop</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pricingUrl">Pricing Policy URL</label>
                        <input type="url" id="pricingUrl" placeholder="https://example.com/pricing" required>
                    </div>

                    <button type="submit" class="run-button" id="runButton">
                        Run Analysis
                    </button>
                </form>
            </div>

            <div class="timeline-section">
                <h2>Agent Timeline</h2>
                <div class="timeline" id="timeline">
                    <div class="timeline-item">
                        <div class="timeline-type">Ready</div>
                        <div class="timeline-content">
                            <div>Upload your CSV file and pricing URL to begin analysis</div>
                            <div class="timeline-timestamp">Waiting for input...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <h2>Analysis Results</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        class BikeShareOptimizer {
            constructor() {
                this.form = document.getElementById('analysisForm');
                this.csvFile = document.getElementById('csvFile');
                this.pricingUrl = document.getElementById('pricingUrl');
                this.runButton = document.getElementById('runButton');
                this.timeline = document.getElementById('timeline');
                this.resultsSection = document.getElementById('resultsSection');
                this.resultsContent = document.getElementById('resultsContent');
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.csvFile.addEventListener('change', (e) => this.handleFileChange(e));
            }

            handleFileChange(event) {
                const file = event.target.files[0];
                const label = document.getElementById('fileLabel');
                
                if (file) {
                    label.textContent = `Selected: ${file.name}`;
                } else {
                    label.textContent = 'Choose CSV file or drag and drop';
                }
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                const formData = new FormData();
                formData.append('csvFile', this.csvFile.files[0]);
                formData.append('pricingUrl', this.pricingUrl.value);
                
                this.runButton.disabled = true;
                this.runButton.textContent = 'Analyzing...';
                this.clearTimeline();
                this.addTimelineItem('Thought', 'Starting analysis...');
                
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    this.displayResults(result);
                    
                } catch (error) {
                    this.addTimelineItem('Error', `Analysis failed: ${error.message}`);
                    console.error('Analysis error:', error);
                } finally {
                    this.runButton.disabled = false;
                    this.runButton.textContent = 'Run Analysis';
                }
            }

            clearTimeline() {
                this.timeline.innerHTML = '';
            }

            addTimelineItem(type, content, toolArgs = null) {
                const item = document.createElement('div');
                item.className = `timeline-item ${type.toLowerCase()}`;
                
                const typeElement = document.createElement('div');
                typeElement.className = `timeline-type ${type.toLowerCase()}`;
                typeElement.textContent = type;
                
                const contentElement = document.createElement('div');
                contentElement.className = 'timeline-content';
                contentElement.innerHTML = `
                    <div>${content}</div>
                    <div class="timeline-timestamp">${new Date().toLocaleTimeString()}</div>
                `;
                
                if (toolArgs) {
                    const toolArgsElement = document.createElement('div');
                    toolArgsElement.style.marginTop = '10px';
                    toolArgsElement.style.fontSize = '0.9rem';
                    toolArgsElement.style.color = '#6c757d';
                    toolArgsElement.innerHTML = `<strong>Tool Args:</strong> <code>${JSON.stringify(toolArgs)}</code>`;
                    contentElement.appendChild(toolArgsElement);
                }
                
                item.appendChild(typeElement);
                item.appendChild(contentElement);
                this.timeline.appendChild(item);
                
                this.timeline.scrollTop = this.timeline.scrollHeight;
            }

            displayResults(result) {
                if (result.steps) {
                    result.steps.forEach(step => {
                        this.addTimelineItem(step.type, step.content, step.toolArgs);
                    });
                }
                
                this.resultsSection.style.display = 'block';
                
                let html = `
                    <div class="decision-card">
                        <h3>ðŸŽ¯ Recommendation</h3>
                        <div class="recommendation">${result.decision}</div>
                        <p>${result.justification}</p>
                    </div>
                `;
                
                if (result.costBreakdown) {
                    const costs = result.costBreakdown;
                    html += `
                        <div class="cost-comparison">
                            <div class="cost-card">
                                <h4>Pay-Per-Use</h4>
                                <div class="cost-amount">$${costs.payPerUse.total.toFixed(2)}</div>
                                <div>Per trip: $${costs.payPerUse.perTrip.toFixed(2)}</div>
                            </div>
                            <div class="cost-card">
                                <h4>Monthly Membership</h4>
                                <div class="cost-amount">$${costs.membership.total.toFixed(2)}</div>
                                <div>Overage: $${costs.membership.overageCharges.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="cost-card" style="margin: 20px 0;">
                            <h4>ðŸ’° Savings</h4>
                            <div class="cost-amount ${costs.savings > 0 ? 'savings' : ''}">
                                ${costs.savings > 0 ? '+' : ''}$${Math.abs(costs.savings).toFixed(2)}
                            </div>
                            <div>${costs.savings > 0 ? 'Pay-per-use saves' : 'Membership saves'} you money</div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="metrics-strip">
                        <div class="metric">
                            <div class="metric-value">${result.totalSteps || 0}</div>
                            <div class="metric-label">Steps</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${((result.totalTime || 0) / 1000).toFixed(1)}s</div>
                            <div class="metric-label">Total Time</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${result.stopReason || 'Unknown'}</div>
                            <div class="metric-label">Stop Reason</div>
                        </div>
                    </div>
                `;
                
                if (result.citations && result.citations.length > 0) {
                    html += `
                        <div class="citations">
                            <h4>ðŸ“š Citations</h4>
                            ${result.citations.map(citation => `
                                <div class="citation-item">
                                    <strong>Source:</strong> <a href="${citation.url}" target="_blank">${citation.url}</a><br>
                                    <strong>Retrieved:</strong> ${new Date(citation.date).toLocaleString()}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                this.resultsContent.innerHTML = html;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new BikeShareOptimizer();
        });
    </script>
</body>
</html>
